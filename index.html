<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatWithMe MCP</title>
  </head>
  <body>
    <div id="root"></div>
    <script>
      (() => {
        const reloadGuardKey = "chatwithme-asset-reload-once";

        function shouldHandleAssetError(message) {
          return (
            message.includes("Failed to fetch dynamically imported module") ||
            message.includes("disallowed MIME type") ||
            message.includes("NS_ERROR_CORRUPTED_CONTENT")
          );
        }

        function reloadOnce() {
          if (sessionStorage.getItem(reloadGuardKey) === "1") {
            return;
          }

          sessionStorage.setItem(reloadGuardKey, "1");
          const url = new URL(window.location.href);
          url.searchParams.set("v", Date.now().toString());
          window.location.replace(url.toString());
        }

        window.addEventListener(
          "error",
          (event) => {
            const target = event.target;
            if (target instanceof HTMLScriptElement && target.src.includes("/assets/")) {
              reloadOnce();
              return;
            }

            const message = String((event && "message" in event && event.message) || "");
            if (shouldHandleAssetError(message)) {
              reloadOnce();
            }
          },
          true
        );

        window.addEventListener("unhandledrejection", (event) => {
          const reason = event.reason;
          const message = String(
            (reason && typeof reason === "object" && "message" in reason && reason.message) || reason || ""
          );
          if (shouldHandleAssetError(message)) {
            reloadOnce();
          }
        });

        window.addEventListener("load", () => {
          sessionStorage.removeItem(reloadGuardKey);
        });
      })();
    </script>
    <script type="module" src="/src/client.tsx"></script>
  </body>
</html>
